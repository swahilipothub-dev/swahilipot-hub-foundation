<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/admin/attachments">Industrial Attachments</a></li>
                    <li class="breadcrumb-item active" aria-current="page">View Attachment</li>
                </ol>
            </nav>
            <h1 class="h3 mb-0 mt-2">Attachment Details</h1>
        </div>
        <div>
            <a href="/admin/attachments" class="btn btn-outline-secondary me-2">
                <i class="fas fa-arrow-left me-2"></i> Back to List
            </a>
            <a href="/admin/attachments/<%= attachment._id %>/edit" class="btn btn-primary">
                <i class="fas fa-edit me-2"></i> Edit
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Student Information</h5>
                    <span class="badge bg-<%= 
                        attachment.status === 'approved' ? 'success' : 
                        attachment.status === 'rejected' ? 'danger' : 'secondary'
                    %>">
                        <%= attachment.status ? attachment.status.charAt(0).toUpperCase() + attachment.status.slice(1) : 'Pending' %>
                    </span>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Full Name</label>
                                <p class="form-control-static"><%= `${attachment.first_name} ${attachment.middle_name ? attachment.middle_name + ' ' : ''}${attachment.last_name}` %></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Email</label>
                                <p class="form-control-static"><%= attachment.email %></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Phone Number</label>
                                <p class="form-control-static"><%= attachment.phone_number || 'N/A' %></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Date of Birth</label>
                                <p class="form-control-static"><%= new Date(attachment.date_of_birth).toLocaleDateString() %></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Gender</label>
                                <p class="form-control-static"><%= attachment.gender ? attachment.gender.charAt(0).toUpperCase() + attachment.gender.slice(1) : 'N/A' %></p>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Residential Location</label>
                                <p class="form-control-static"><%= attachment.residential_location || 'N/A' %></p>
                            </div>
                        </div>
                    </div>

                    <h5 class="mb-3">Education Information</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Institution</label>
                                <p class="form-control-static"><%= attachment.institution?.name || 'N/A' %></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Department</label>
                                <p class="form-control-static"><%= attachment.department?.name || 'N/A' %></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Course</label>
                                <p class="form-control-static"><%= attachment.course?.name || 'N/A' %></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Year of Study</label>
                                <p class="form-control-static"><%= attachment.year_of_study || 'N/A' %></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Expected Graduation</label>
                                <p class="form-control-static"><%= attachment.expected_graduation_date ? new Date(attachment.expected_graduation_date).toLocaleDateString() : 'N/A' %></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Available Start Date</label>
                                <p class="form-control-static"><%= attachment.available_start_date ? new Date(attachment.available_start_date).toLocaleDateString() : 'N/A' %></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Can Attend Onsite</label>
                                <p class="form-control-static">
                                    <span class="badge bg-<%= attachment.can_attend_onsite ? 'success' : 'secondary' %>">
                                        <%= attachment.can_attend_onsite ? 'Yes' : 'No' %>
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <h5 class="mb-3">Additional Information</h5>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">About Yourself</label>
                        <div class="border rounded p-3 bg-light">
                            <%= attachment.about_yourself || 'N/A' %>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Community Engagement</label>
                        <div class="border rounded p-3 bg-light">
                            <%= attachment.community_engagement_statement || 'N/A' %>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Understanding of Swahilipot</label>
                        <div class="border rounded p-3 bg-light">
                            <%= attachment.understanding_of_swahilipot || 'N/A' %>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">LinkedIn Profile</label>
                                <p class="form-control-static">
                                    <% if (attachment.linkedin_url) { %>
                                        <a href="<%= attachment.linkedin_url %>" target="_blank" class="text-decoration-none">
                                            <i class="fab fa-linkedin me-1"></i> View Profile
                                        </a>
                                    <% } else { %>
                                        N/A
                                    <% } %>
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">GitHub Profile</label>
                                <p class="form-control-static">
                                    <% if (attachment.github_url) { %>
                                        <a href="<%= attachment.github_url %>" target="_blank" class="text-decoration-none">
                                            <i class="fab fa-github me-1"></i> View Profile
                                        </a>
                                    <% } else { %>
                                        N/A
                                    <% } %>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <% if (attachment.status === 'pending') { %>
                            <button class="btn btn-success mb-2" onclick="updateStatus('<%= attachment._id %>', 'approved')">
                                <i class="fas fa-check me-2"></i> Approve Application
                            </button>
                            <button class="btn btn-danger mb-2" onclick="updateStatus('<%= attachment._id %>', 'rejected')">
                                <i class="fas fa-times me-2"></i> Reject Application
                            </button>
                        <% } else if (attachment.status === 'approved') { %>
                            <button class="btn btn-warning mb-2" onclick="updateStatus('<%= attachment._id %>', 'pending')">
                                <i class="fas fa-undo me-2"></i> Set as Pending
                            </button>
                            <button class="btn btn-danger mb-2" onclick="updateStatus('<%= attachment._id %>', 'rejected')">
                                <i class="fas fa-times me-2"></i> Reject Application
                            </button>
                        <% } else { %>
                            <button class="btn btn-success mb-2" onclick="updateStatus('<%= attachment._id %>', 'approved')">
                                <i class="fas fa-check me-2"></i> Approve Application
                            </button>
                            <button class="btn btn-warning mb-2" onclick="updateStatus('<%= attachment._id %>', 'pending')">
                                <i class="fas fa-undo me-2"></i> Set as Pending
                            </button>
                        <% } %>
                        
                        <a href="/api/attachments/<%= attachment._id %>/download" class="btn btn-outline-primary mb-2">
                            <i class="fas fa-download me-2"></i> Download Application
                        </a>
                        
                        <button class="btn btn-outline-danger" 
                                data-bs-toggle="modal" 
                                data-bs-target="#deleteModal"
                                data-id="<%= attachment._id %>">
                            <i class="fas fa-trash-alt me-2"></i> Delete Application
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Application Details</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Application Date</label>
                        <p class="form-control-static">
                            <%= new Date(attachment.createdAt).toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            }) %>
                        </p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Last Updated</label>
                        <p class="form-control-static">
                            <%= new Date(attachment.updatedAt).toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            }) %>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="statusToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body"></div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this attachment? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
// Handle delete confirmation
const deleteModal = document.getElementById('deleteModal');
if (deleteModal) {
    deleteModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const attachmentId = button.getAttribute('data-id');
        
        document.getElementById('confirmDelete').onclick = function() {
            fetch(`/api/attachments/${attachmentId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = '/admin/attachments';
                } else {
                    alert('Error deleting attachment: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting attachment');
            });
        };
    });
}

// Handle status updates
function updateStatus(attachmentId, status) {
    if (!confirm('Are you sure you want to set this application as ' + status + '?')) {
        return;
    }
    
    // Show loading state
    var buttons = document.querySelectorAll('button[onclick*="updateStatus(\'' + attachmentId + '\'"]');
    buttons.forEach(function(btn) {
        btn.disabled = true;
        var originalHTML = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Updating...';
        btn._originalHTML = originalHTML;
    });
    
    fetch('/api/attachments/' + attachmentId + '/status', {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({ status: status })
    })
    .then(function(response) {
        if (!response.ok) {
            return response.json().then(function(err) {
                throw new Error(err.message || 'Failed to update status');
            });
        }
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            // Show success message and reload the page to reflect changes
            var toast = new bootstrap.Toast(document.getElementById('statusToast'));
            var toastBody = document.querySelector('#statusToast .toast-body');
            toastBody.textContent = 'Application has been ' + status + ' successfully';
            toast.show();
            
            // Reload the page after a short delay
            setTimeout(function() {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.message || 'Failed to update status');
        }
    })
    .catch(function(error) {
        console.error('Error updating status:', error);
        alert('Error: ' + error.message);
        // Reset buttons
        buttons.forEach(function(btn) {
            btn.disabled = false;
            if (btn._originalHTML) {
                btn.innerHTML = btn._originalHTML;
            }
        });
    });
}
</script>
