<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swahilipot Hub Admin - <%= typeof title !== 'undefined' ? title : 'Admin' %></title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/admin.css">
    
    <!-- Auth Token -->
    <% if (typeof token !== 'undefined' && token) { %>
    <meta name="auth-token" content="<%= token %>">
    <% } %>
</head>
<body class="d-flex">
    <!-- Sidebar -->
    <%- include('partials/sidebar', { path: currentPath || '/' }) %>

    <!-- Page content wrapper -->
    <div class="flex-grow-1 d-flex flex-column min-vh-100">
        <!-- Top navbar -->
        <%- include('partials/header') %>

        <!-- Main content -->
        <main class="flex-grow-1 p-4">
            <%- body %>
        </main>

        <!-- Footer -->
        <footer class="bg-light py-3 border-top">
            <div class="container">
                <div class="text-center text-muted">
                    &copy; <%= new Date().getFullYear() %> Swahilipot Hub Foundation. All rights reserved.
                </div>
            </div>
        </footer>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize auth token for API requests
        (function() {
            const token = document.querySelector('meta[name="auth-token"]')?.content;
            if (token) {
                // Set default Authorization header for all fetch requests
                const originalFetch = window.fetch;
                window.fetch = function(resource, options = {}) {
                    // Only add token to same-origin requests
                    const isSameOrigin = !resource.startsWith('http') || 
                                      resource.startsWith(window.location.origin);
                    
                    if (isSameOrigin) {
                        options.headers = {
                            ...options.headers,
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        };
                    }
                    
                    return originalFetch(resource, options);
                };
                
                // Store token in localStorage for SPA navigation
                localStorage.setItem('token', token);
            }
        })();
    </script>
    <script src="/js/admin.js"></script>
    <script>
        // Handle logout
        document.addEventListener('DOMContentLoaded', function() {
            const logoutLink = document.getElementById('logoutLink');
            const logoutForm = document.getElementById('logoutForm');
            
            if (logoutLink && logoutForm) {
                logoutLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Submit the logout form
                    fetch('/api/auth/logout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        credentials: 'same-origin' // Important for cookies
                    })
                    .then(response => {
                        if (response.redirected) {
                            window.location.href = response.url; // Handle redirect to login
                        } else {
                            return response.json().then(data => {
                                if (data.message === 'Logout successful') {
                                    window.location.href = '/login';
                                }
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Logout error:', error);
                        window.location.href = '/login'; // Redirect to login even if there's an error
                    });
                });
            }
        });
    </script>
</body>
</html>
